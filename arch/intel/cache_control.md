
### 12.11.8 MTRR Considerations in MP Systems
* 在 MP（多处理器）系统中，操作系统必须保持系统中所有处理器之间的 MTRR 一致性。
  * Pentium 4、Intel Xeon 和 P6 系列处理器不提供硬件支持来保持这种一致性。一般来说，所有处理器必须具有相同的 MTRR 值。
* 此要求意味着，当操作系统初始化 MP 系统时，必须在寄存器 `MTRRdefType` 中的 `E` 标志为 `0` 时加载引导处理器的 MTRR。
  * 然后，操作系统指示其他处理器使用相同的内存映射加载其 MTRR。
  * 当所有处理器都加载了它们的 MTRR 后，操作系统会向它们发出信号以启用它们的 MTRR。
  * 屏障同步用于防止进一步的内存访问，直到所有处理器指示 MTRR 已启用。
    * 这种同步很可能是一种 shoot-down style 算法，会采用共享变量和处理器间中断。
* 对 MP 系统中 MTRR 值的任何更改都需要操作系统使用以下过程重复加载和启用过程以保持一致性：
1. 向所有处理器广播以执行以下代码序列。
2. 禁用中断。
3. 等待所有处理器都到达此点。
4. 进入无填充（no-fill）cache 模式。（将控制寄存器 `CR0` 中的 `CD` 标志设置为 `1`，将 `NW` 标志设置为 `0`。）
5. 使用 `WBINVD` 指令刷新所有 caches。注意，对于支持自侦听（self-snooping）、CPUID 功能标志位 `27` 的处理器，此步骤是不必要的。
6. 如果控制寄存器 `CR4` 中设置了 `PGE` 标志，则通过清除该标志来刷新所有 TLB。
7. 如果控制寄存器 `CR4` 中的 `PGE` 标志被清除，则通过执行从控制寄存器 `CR3` 到另一个寄存器的 `MOV`，然后从该寄存器执行回 `CR3` 的 `MOV` 来刷新所有 TLB。
8. 禁用所有范围寄存器（通过清除寄存器 `MTRRdefType` 中的 `E` 标志）。如果仅修改变量范围，软件可能会清除受影响的寄存器对的有效位。
9. 更新 MTRR。
10. 启用所有范围寄存器（通过设置寄存器 `MTRRdefType` 中的 `E` 标志）。如果仅修改了可变范围寄存器并且清除了它们各自的有效位，则改为设置受影响范围的有效位。
11. 再次刷新所有 caches 和所有 TLB。（Pentium 4、Intel Xeon 和 P6 系列处理器需要 TLB 刷新。使用 Pentium 4、Intel Xeon 和 P6 系列处理器时不需要执行 `WBINVD` 指令，但在未来的系统中可能需要。）
12. 进入正常 cache 模式以重新启用 caching。（将控制寄存器 `CR0` 中的 `CD` 和 `NW` 标志设置为 `0`。）
13. 如果在步骤 6（上述）中清除，则在控制寄存器 `CR4` 中设置 `PGE` 标志。
14. 等待所有处理器到达此点。
15. 启用中断。

* 对应到代码 arch/x86/kernel/cpu/mtrr/mtrr.c:`set_mtrr()`